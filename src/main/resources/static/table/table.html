<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>VUE自定义组件</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
    <script src="/static/layuiadmin/layui/layui.js"></script>
    <script src="/static/common/utils.js"></script>
    <script src="/static/vue/vue.min.js"></script>
    <script src="/static/vue/Sortable.min.js"></script>
    <script src="/static/vue/vuedraggable.umd.min.js"></script>
    <script src="/static/element-ui@2.14.1/index.js"></script>
    <link rel="stylesheet" href="app.css" type="text/css"/>
    <link rel="stylesheet" href="/static/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/static/layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="/static/element-ui@2.14.1/index.css" media="all">
</head>
<body>
<div id="app">
    <div class="container page">
        <div class="layer title">Page</div>
        <div class="panel">
            <draggable v-model="page" group="dim" animation="100" drag-class="drag" ghost-class="ghost"
                       chosen-class="chosen" handle=".drag-handle" @start="onStart" @end="onEnd" :move="onMove">
                <div class="item" v-for="item in page">
                    <div class="drag-handle">&#9776; {{item.dimName}}</div>
                    <el-select v-model="item.selectedMember" placeholder="请选择">
                        <el-option v-for="option in item.options" :class="`indent${option.generation}`"
                                   :key="option.code" :label="option.displayName"
                                   :value="option.code">
                        </el-option>
                    </el-select>
                </div>
            </draggable>
        </div>
    </div>

    <div class="container row">
        <div class="layer title" @click="exchange">Row</div>
        <div class="panel">
            <draggable v-model="row" group="dim" animation="100" drag-class="drag" ghost-class="ghost"
                       chosen-class="chosen" @start="onStart" @end="onEnd">
                <div class="item" v-for="item in row">
                    <div class="drag-handle">&#9776; {{item.dimName}}</div>
                </div>
            </draggable>
        </div>
    </div>
    <div class="maintable">
        <table class="layui-hide" id="maintable" lay-filter="maintable">
        </table>
    </div>
    <div class="container col">
        <div class="layer title">Col</div>
        <div id="col" class="panel">
            <draggable v-model="col" group="dim" animation="100" drag-class="drag" ghost-class="ghost"
                       chosen-class="chosen" @start="onStart" @end="onEnd">
                <div class="item" v-for="item in col">
                    <div class="drag-handle">&#9776; {{item.dimName}}</div>
                </div>
            </draggable>
        </div>
    </div>
</div>
<script>
    Vue.component('vuedraggable', window.vuedraggable.name);
    layui.config({
        base: '/static/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'jquery', 'layer', 'form', 'table'], function () {
        window.$ = layui.$, window.layer = layui.layer, window.form = layui.form;
        Ctable.initPages();
        Ctable.LoadTabeData();
        Ctable.bindTableEvent();
    });

    var Ctable = {
        initPages: function () {
            window.app = new Vue({
                el: '#app',
                components: {
                    vuedraggable,
                }, created: function () {
                    this.initPages();
                }
                , updated: function () {
                    Ctable.freshTable(this.page, this.col, this.row);
                }
                , data() {
                    return {
                        drag: false,
                        page: [],
                        col: [],
                        row: []
                    };
                },
                methods: {
                    initPages() {
                        var cubeid = "133874023144632320";
                        fetchGet("/cube/getPages?id=" + cubeid, function (data) {
                            app.page = data;
                        });
                    },
                    onStart() {
                        this.drag = true;
                    },
                    onEnd() {
                        this.drag = false;
                    },
                    onMove(e) {
                        // if (e.draggedContext.element.id == 4) return false;
                        return true;
                    },
                    exchange() {
                        var temp = this.row;
                        this.row = this.col;
                        this.col = temp;
                    }

                }
            });
        },
        freshTable(page, row, col) {
            console.log(page);
            console.log(row);
            console.log(col);
        }, bindTableEvent() {
            //监听单元格编辑
            table.on('edit(maintable)', function (obj) {
                var value = obj.value //得到修改后的值
                    , data = obj.data //得到所在行所有键值
                    , field = obj.field; //得到字段
                fetchPost("/cube/updateValue", {code: data.code, attrvalue: value, attrname: field})
            });
            //监听行单击事件（双击事件为：rowDouble）
            table.on('row(maintable)', function (obj) {
                var data = obj.data;
                //标注选中样式
                obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
            });

            //监听单元格事件
            table.on('tool(maintable)', function (obj) {
                let attrids = obj.event.split(',');
                FIELD = attrids[0];
                ATTRID = attrids[1];
            });
        }, LoadTabeData() {
            fetchGet('/attr/list?dimid=' + dimid, (data) => {
                var tableoptions = {};
                if (!data || data.length == 0) {
                    tableoptions = {
                        elem: '#attrtable'
                        , id: 'attrtable'
                        , height: 'full-85'
                        , cols: [[{field: 'col', title: '无'}]]
                        , data: []
                    };
                } else {
                    //展示已知数据
                    tableoptions = {
                        elem: '#attrtable'
                        , id: 'attrtable'
                        , height: 'full-85'
                        , cols: [data]
                        , url: '/attrvalue/listAttrValues?dimid=' + dimid
                        , parseData: function (res) { //res 即为原始返回的数据
                            return {
                                "code": res.code == 200 ? 0 : res.code, //解析接口状态
                                "msg": res.message, //解析提示文本
                                "count": res.data.length, //解析数据长度
                                "data": res.data //解析数据列表
                            };
                        }
                    };

                }
                table.reload('maintable', tableoptions);//重载

            });
        }
    }
</script>
</body>
</html>